<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Son Depremler</title>
    <meta
      name="description"
      content="Son 3 ay içindeki depremler – USGS canlı verileri ile interaktif harita"
    />
    <meta
      name="keywords"
      content="deprem, son depremler, interactive map, earthquakes, Türkiye deprem, USGS"
    />
    <meta name="robots" content="index, follow" />

    <!-- Canonical and Hreflang -->
    <link rel="canonical" href="https://mapelse.github.io/son-depremler.html" />
    <link
      rel="alternate"
      hreflang="tr"
      href="https://mapelse.github.io/son-depremler.html"
    />
    <link
      rel="alternate"
      hreflang="en"
      href="https://mapelse.github.io/son-depremler.html?lang=en"
    />

    <!-- Open Graph -->
    <meta property="og:locale" content="tr_TR" />
    <meta property="og:locale:alternate" content="en_US" />
    <meta property="og:type" content="website" />
    <meta
      property="og:title"
      content="Son Depremler - Interaktif Deprem Haritası"
    />
    <meta
      property="og:description"
      content="Son 3 ay içindeki depremler – USGS canlı verileri ile interaktif harita"
    />
    <meta
      property="og:url"
      content="https://mapelse.github.io/son-depremler.html"
    />
    <meta property="og:site_name" content="Mapelse Son Depremler" />
    <meta
      property="og:image"
      content="https://mapelse.github.io/assets/images/preview.png"
    />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@mapelse" />
    <meta
      name="twitter:title"
      content="Son Depremler - Interaktif Deprem Haritası"
    />
    <meta
      name="twitter:description"
      content="Son 3 ay içindeki depremler – USGS canlı verileri ile interaktif harita"
    />
    <meta
      name="twitter:image"
      content="https://mapelse.github.io/assets/images/preview.png"
    />

    <!-- Structured Data -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "Son Depremler",
        "url": "https://mapelse.github.io/son-depremler.html",
        "description": "Interaktif harita ile son 3 ay içindeki depremler bilgisi",
        "inLanguage": "tr"
      }
    </script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      html,
      body,
      #map {
        height: 100%;
        margin: 0;
        padding: 0;
        font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
      }
      .pulse {
        width: 35px;
        height: 35px;
        margin: -12px;
        border-radius: 50%;
        background: rgb(0, 101, 244);
        border: 2px solid white;
        opacity: 0.8;
        animation: pulse 2s ease-out infinite;
        cursor: pointer;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 white;
        }
        70% {
          box-shadow: 0 0 0 24px rgba(255, 0, 0, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
        }
      }
      .legend {
        background: white;
        padding: 10px;
        line-height: 1.5em;
        color: #333;
        font-size: 12px;
      }
      .legend .title {
        font-weight: bold;
        margin-bottom: 5px;
      }
      .legend-color {
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-right: 5px;
        vertical-align: middle;
      }
      .lang-toggle {
        background: white;
        border: none;
        padding: 5px 8px;
        cursor: pointer;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof L === "undefined")
          return console.error("Leaflet yüklenemedi");
        let lang = "tr";
        const translations = {
          tr: {
            title: "Zaman",
            wk: "Son 1 hafta",
            mo: "1 hafta - 1 ay",
            ma: "1 ay - 3 ay",
            magnitude: "Magnit&uuml;d",
            place: "Yer",
            time: "Zaman",
            details: "Detay",
          },
          en: {
            title: "Time",
            wk: "Last 1 week",
            mo: "1 week - 1 month",
            ma: "1 month - 3 months",
            magnitude: "Magnitude",
            place: "Location",
            time: "Time",
            details: "Details",
          },
        };
        const map = L.map("map").setView([39.0, 35.0], 3);
        L.tileLayer(
          "https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.{ext}",
          {
            minZoom: 0,
            maxZoom: 20,
            attribution:
              '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            ext: "png",
          }
        ).addTo(map);

        // Language toggle button
        const langControl = L.control({ position: "topright" });
        langControl.onAdd = () => {
          const btn = L.DomUtil.create("button", "lang-toggle");
          btn.innerText = "EN";
          btn.onclick = () => {
            toggleLang();
          };
          return btn;
        };
        langControl.addTo(map);

        let legend;
        function addLegend() {
          if (legend) map.removeControl(legend);
          legend = L.control({ position: "bottomright" });
          legend.onAdd = () => {
            const div = L.DomUtil.create("div", "legend");
            const t = translations[lang];
            div.innerHTML =
              `<div class="title">${t.title}</div>` +
              `<div><span class="legend-color" style="background:#FF0000"></span> ${t.wk}</div>` +
              `<div><span class="legend-color" style="background:#ffb703"></span> ${t.mo}</div>` +
              `<div><span class="legend-color" style="background:#faf689"></span> ${t.ma}</div>`;
            return div;
          };
          legend.addTo(map);
        }

        let heatLayer;
        const depremler = L.geoJson(null, {
          pointToLayer: (f, latlng) => {
            const mag = f.properties.mag;
            const radius = mag * 2;
            const ageDays =
              (Date.now() - f.properties.time) / (1000 * 60 * 60 * 24);
            let fillColor =
              ageDays < 7 ? "#FF0000" : ageDays < 30 ? "#ffb703" : "#faf689";
            return L.circleMarker(latlng, {
              radius,
              weight: 0.6,
              color: "#000",
              fillColor,
              fillOpacity: 0.7,
            });
          },
          onEachFeature: (f, l) => {
            const p = f.properties;
            const t = translations[lang];
            l.bindPopup(
              `<b>${t.magnitude}:</b> ${p.mag}<br>` +
                `<b>${t.place}:</b> ${p.place}<br>` +
                `<b>${t.time}:</b> ${new Date(p.time).toLocaleString()}<br>` +
                `<a href="${p.url}" target="_blank">${t.details}</a>`
            );
          },
        }).addTo(map);

        let pulseMarker;
        async function loadQuakes() {
          const startDate = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000)
            .toISOString()
            .split("T")[0];
          const endDate = new Date().toISOString().split("T")[0];
          const url = `https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&starttime=${startDate}&endtime=${endDate}&minmagnitude=3&orderby=time`;
          try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            depremler.clearLayers();
            const heatPoints = data.features.map((f) => {
              const [lng, lat] = f.geometry.coordinates;
              return [lat, lng, f.properties.mag];
            });
            if (heatLayer) heatLayer.setLatLngs(heatPoints);
            else
              heatLayer = L.heatLayer(heatPoints, {
                radius: 25,
                blur: 15,
                maxZoom: 6,
              });
            depremler.addData(data);
            const latest = data.features[0];
            if (latest) {
              const [lng, lat] = latest.geometry.coordinates;
              const p = latest.properties;
              const t = translations[lang];
              const popup =
                `<b>${t.magnitude}:</b> ${p.mag}<br>` +
                `<b>${t.place}:</b> ${p.place}<br>` +
                `<b>${t.time}:</b> ${new Date(p.time).toLocaleString()}<br>` +
                `<a href="${p.url}" target="_blank">${t.details}</a>`;
              if (pulseMarker) map.removeLayer(pulseMarker);
              pulseMarker = L.marker([lat, lng], {
                icon: L.divIcon({ className: "pulse" }),
              }).addTo(map);
              pulseMarker.bindPopup(popup);
            }
            toggleLayers();
          } catch (err) {
            console.error("Deprem verisi alınırken hata:", err.message);
          }
        }

        function toggleLayers() {
          const z = map.getZoom();
          if (z <= 2) {
            if (!map.hasLayer(heatLayer)) map.addLayer(heatLayer);
            if (map.hasLayer(depremler)) map.removeLayer(depremler);
            if (pulseMarker) map.removeLayer(pulseMarker);
          } else {
            if (!map.hasLayer(depremler)) map.addLayer(depremler);
            if (map.hasLayer(heatLayer)) map.removeLayer(heatLayer);
            if (pulseMarker) map.addLayer(pulseMarker);
          }
        }

        function toggleLang() {
          lang = lang === "tr" ? "en" : "tr";
          document.documentElement.lang = lang;
          // Update button text
          document.querySelector(".lang-toggle").innerText =
            lang === "tr" ? "EN" : "TR";
          // Update title and meta description
          document.title = lang === "tr" ? "Son Depremler" : "Latest Quakes";
          document
            .querySelector("meta[name=description]")
            .setAttribute(
              "content",
              lang === "tr"
                ? "Son 3 ay içindeki depremler – USGS canlı verileri ile interaktif harita"
                : "Interactive map of last 3 months earthquakes – live USGS data"
            );
          // Re-add legend and refresh popups
          addLegend();
          loadQuakes();
        }

        map.on("zoomend", toggleLayers);
        addLegend();
        loadQuakes();
        setInterval(loadQuakes, 10 * 60 * 1000);
      });
    </script>
  </body>
</html>
